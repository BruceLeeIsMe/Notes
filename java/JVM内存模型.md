# Java内存模型

这是逻辑模型。

**主内存**

可以理解为，对应计算机内存条中的数据，线程共享的区域。

**直接内存**

可以理解为，对应计算机CPU与主存之间的高速缓冲区，是线程私有的区域。

## 三大特性

### 原子性

 原子性指的是一个操作是不可中断的，即使是在多线程环境下，一个操作一旦开始就不会被其他线程影响。 

### 可见性

可见性指的是当一个线程修改了某个共享变量的值，其他线程是否能够马上得知这个修改的值。对于串行程序来说，可见性是不存在的，因为我们在任何一个操作中修改了某个变量的值，后续的操作中都能读取这个变量值，并且是修改过的新值。 

### 有序性

概念：指令重排，因为虚拟机和操作系统会对指令进行优化，导致代码乱序执行。

指令重排只会保证单线程中串行语义的执行的一致性，但并不会关心多线程间的语义一致性。 

## 线程安全问题：

线程安全问题产生的原因：

线程操作直接内存，而该区域是线程私有的，将直接内存的内容刷新至主存会有短暂延迟，从而导致的线程安全问题。



# JMM（java memory model）的解决方案

在Java内存模型中都提供一套解决方案供Java工程师在开发过程使用，如原子性问题，除了JVM自身提供的对基本数据类型读写操作的原子性外，对于方法级别或者代码块级别的原子性操作，可以使用synchronized关键字或者重入锁(ReentrantLock)保证程序执行的原子性。

而工作内存与主内存同步延迟现象导致的可见性问题，可以使用synchronized关键字或者volatile关键字解决，它们都可以使一个线程修改后的变量立即对其他线程可见。对于指令重排导致的可见性问题和有序性问题，则可以利用volatile关键字解决，因为volatile的另外一个作用就是禁止重排序优化。

## volatile

语义：

volatile在并发编程中很常见，但也容易被滥用，现在我们就进一步分析volatile关键字的语义。volatile是Java虚拟机提供的轻量级的同步机制。volatile关键字有如下两个作用

- 可见性，保证被volatile修饰的共享gong’x变量对所有线程总数可见的，也就是当一个线程修改了一个被volatile修饰共享变量的值，新值总数可以被其他线程立即得知。


- 禁止指令重排序优化。

**使用volatile可以保证线程安全吗？**

答案：部分情况可以，当volatile修饰的变量进行原子操作时可以保证线程安全。

```
volatile int a=1;

a=2;//原子操作，线程安全

a++;//非原子操作，非线程安全
```



## ReentrantLock

## synchronized以及锁升级过程

另起一篇

